// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?   @map("password_hash")
  name          String?
  googleId      String?   @unique @map("google_id")
  profilePicture String?  @map("profile_picture")
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  userData         UserData?
  references       Reference[]
  certificates     Certificate[]
  payments         Payment[]
  interviewSession InterviewSession[]
  idVerification   IDVerification?
  refreshTokens    RefreshToken[]
  sessions         Session[]
  interviews       Interview[]
  assessmentPlans  AssessmentPlan[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique // SHA-256 hashed
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model UserData {
  id                     String   @id @default(uuid())
  userId                 String   @unique @map("user_id")
  purchasedProducts      String[] @default([]) @map("purchased_products")
  interviewProgress      Json     @default("{}") @map("interview_progress")
  idVerificationStatus   String   @default("not-started") @map("id_verification_status")
  referenceCheckStatus   String   @default("not-started") @map("reference_check_status")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_data")
}

model Reference {
  id                   String    @id @default(uuid())
  userId               String    @map("user_id")
  name                 String
  email                String
  company              String
  position             String
  relationship         String
  phone                String?
  status               String    @default("draft")
  submittedAt          DateTime? @map("submitted_at")
  responseReceivedAt   DateTime? @map("response_received_at")
  verifiedAt           DateTime? @map("verified_at")
  responseData         Json?     @map("response_data")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("references")
}

model Certificate {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  productId         String   @map("product_id")
  certificateNumber String   @unique @map("certificate_number")
  issueDate         DateTime @default(now()) @map("issue_date")
  status            String   @default("active")
  skillsData        Json?    @map("skills_data")
  pdfUrl            String?  @map("pdf_url")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([certificateNumber])
  @@map("certificates")
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Int      // Price in cents
  currency    String   @default("USD")
  type        String?  // e.g., "skill", "id-visa", "reference", "combo"
  features    Json?    // Array of features
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  payments Payment[]

  @@index([type])
  @@index([active])
  @@map("products")
}

model Payment {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  productId        String   @map("product_id")
  amount           Int
  currency         String   @default("usd")
  status           String
  paymentIntentId  String   @unique @map("payment_intent_id")
  paymentMethodId  String?  @map("payment_method_id")
  invoiceUrl       String?  @map("invoice_url")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@index([userId])
  @@index([productId])
  @@index([paymentIntentId])
  @@map("payments")
}

model InterviewSession {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  role              String
  status            String    @default("in-progress")
  documentsUploaded Boolean   @default(false) @map("documents_uploaded")
  resumeUrl         String?   @map("resume_url")
  coverLetterUrl    String?   @map("cover_letter_url")
  voiceRecordingUrl String?   @map("voice_recording_url")
  mcqScore          Int?      @map("mcq_score")
  mcqTotalQuestions Int?      @map("mcq_total_questions")
  mcqAnswers        Json?     @map("mcq_answers")
  codingSubmission  String?   @map("coding_submission")
  codingPassed      Boolean?  @map("coding_passed")
  evaluationData    Json?     @map("evaluation_data")
  completedAt       DateTime? @map("completed_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("interview_sessions")
}

model IDVerification {
  id              String    @id @default(uuid())
  userId          String    @unique @map("user_id")
  idDocumentUrl   String?   @map("id_document_url")
  idDocumentType  String?   @map("id_document_type")
  visaDocumentUrl String?   @map("visa_document_url")
  visaDocumentType String?  @map("visa_document_type")
  selfieUrl       String?   @map("selfie_url")
  status          String    @default("not-started")
  submittedAt     DateTime? @map("submitted_at")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewNotes     String?   @map("review_notes")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("id_verifications")
}

model MCQQuestion {
  id             String   @id @default(uuid())
  role           String
  question       String
  options        String[]
  correctAnswer  Int      @map("correct_answer")
  category       String
  difficulty     String
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([role])
  @@index([difficulty])
  @@map("mcq_questions")
}

model CodingChallenge {
  id          String   @id @default(uuid())
  role        String
  title       String
  description String
  difficulty  String
  starterCode String   @map("starter_code")
  testCases   Json     @map("test_cases")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([role])
  @@index([difficulty])
  @@map("coding_challenges")
}

model Session {
  id           String    @id @default(uuid())
  sessionId    String    @unique @map("session_id")
  userId       String?   @map("user_id")
  ownerId      String?   @map("owner_id")
  status       String    @default("active")
  data         Json
  lastActivity DateTime  @default(now()) @map("last_activity")
  expiryReason String?   @map("expiry_reason")
  expiredAt    DateTime? @map("expired_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([lastActivity])
  @@map("sessions")
}

model AssessmentPlan {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  resumeText        String   @map("resume_text") @db.Text
  primarySkill      String   @map("primary_skill")
  components        Json
  questionCounts    Json     @map("question_counts")
  difficulty        String
  estimatedDuration Int?     @map("estimated_duration")
  skillBuckets      Json?    @map("skill_buckets")
  interviewPlan     Json     @map("interview_plan")
  idCardUrl         String?  @map("id_card_url")
  status            String   @default("DRAFT")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  interviews Interview[]

  @@index([userId])
  @@index([status])
  @@map("assessment_plans")
}

model Interview {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  assessmentPlanId String    @map("assessment_plan_id")
  questions        Json
  answers          Json?
  status           String    @default("PENDING")
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  score            Float?
  evaluation       Json?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessmentPlan   AssessmentPlan    @relation(fields: [assessmentPlanId], references: [id], onDelete: Cascade)
  proctoringEvents ProctoringEvent[]

  @@index([userId])
  @@index([assessmentPlanId])
  @@index([status])
  @@map("interviews")
}

model ProctoringEvent {
  id             String   @id @default(uuid())
  interviewId    String   @map("interview_id")
  timestamp      DateTime @default(now())
  eventType      String   @map("event_type") // "initial_verification", "continuous_monitor"
  similarity     Float?
  alertTriggered Boolean  @default(false) @map("alert_triggered")
  violationData  Json?    @map("violation_data")

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([interviewId])
  @@index([timestamp])
  @@map("proctoring_events")
}
